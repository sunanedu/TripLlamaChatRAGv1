# Data Flow Diagram - LLM Chat System

## ğŸŒ Public Access Layer (Cloudflare)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Cloudflare CDN                            â”‚
â”‚                  (https://pwa.sri-ketguide.com)                 â”‚
â”‚                  (https://api.sri-ketguide.com)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ HTTPS
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare Tunnels                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tunnel: PWA            â”‚  Tunnel: API                          â”‚
â”‚  cf-tunnel-prod         â”‚  cf-tunnel-api                        â”‚
â”‚  172.20.0.9             â”‚  172.20.0.10                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                â”‚
         â”‚                                â”‚
```

## ğŸ–¥ï¸ Application Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PWA Production                              â”‚
â”‚                  vit-llm-chat-pwa-1                              â”‚
â”‚                  (Nginx + React Build)                          â”‚
â”‚                  Port: 80 â†’ 5174 (host)                          â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ API Requests
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Development Frontend                          â”‚
â”‚                  vit-llm-chat-frontend-1                        â”‚
â”‚                  (Vite Dev Server)                              â”‚
â”‚                  Port: 5173                                     â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP Requests
                            â–¼
```

## ğŸ”§ Backend Services Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Server                                  â”‚
â”‚                  vit-llm-chat-api-1                             â”‚
â”‚                  (Node.js + Express)                             â”‚
â”‚                  Port: 3000                                     â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ HTTP REST API             â”‚ â€¢ JWT Authentication              â”‚
â”‚ â€¢ Chat endpoints            â”‚ â€¢ File Upload                     â”‚
â”‚ â€¢ User management           â”‚ â€¢ SSE Streaming                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                       â”‚
          â”‚ Read/Write                          HTTP
          â”‚                                      â”‚
          â–¼                                      â–¼
```

## ğŸ‘· Background Worker Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Background Worker                            â”‚
â”‚                  vit-llm-chat-worker-1                           â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Process heavy tasks                                            â”‚
â”‚ â€¢ Queue management                                               â”‚
â”‚ â€¢ Async job processing                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ Data Storage Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PostgreSQL Database                           â”‚
â”‚                  vit-llm-chat-database-1                        â”‚
â”‚                  (PostgreSQL 15 + pgvector)                      â”‚
â”‚                  Port: 5432                                      â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Storage:                                                          â”‚
â”‚ â€¢ users (authentication)                                        â”‚
â”‚ â€¢ sessions (chat sessions)                                      â”‚
â”‚ â€¢ messages (chat history)                                       â”‚
â”‚ â€¢ embeddings (vector data with pgvector)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Redis Cache                              â”‚
â”‚                  vit-llm-chat-cache-1                           â”‚
â”‚                  Port: 6379                                     â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cache:                                                            â”‚
â”‚ â€¢ Session data                                                   â”‚
â”‚ â€¢ API responses                                                  â”‚
â”‚ â€¢ Rate limiting counters                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Embedder Service                          â”‚
â”‚                  vit-llm-chat-embedder-1                         â”‚
â”‚                  Port: 11400                                     â”‚
â”‚                  Container: vit_llm-chat-network                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Functions:                                                        â”‚
â”‚ â€¢ Text embedding generation                                      â”‚
â”‚ â€¢ Vector similarity search                                       â”‚
â”‚ â€¢ Semantic search indexing                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— Network Flow

### User Request Flow (PWA):
```
User Browser
    â”‚
    â”œâ”€â–º HTTPS Request â†’ pwa.sri-ketguide.com
    â”‚                      â”‚
    â”‚                      â”œâ”€â–º Cloudflare CDN
    â”‚                      â”‚       â”‚
    â”‚                      â”‚       â”œâ”€â–º Cloudflare Tunnel (cf-tunnel-prod)
    â”‚                      â”‚       â”‚       â”‚
    â”‚                      â”‚       â”‚       â””â”€â–º vit-llm-chat-pwa-1:80
    â”‚                      â”‚       â”‚                   â”‚
    â”‚                      â”‚       â”‚                   â”œâ”€â–º Serves static files (Nginx)
    â”‚                      â”‚       â”‚                   â”‚
    â”‚                      â”‚       â”‚                   â””â”€â–º API calls â†’ api.sri-ketguide.com
    â”‚
    â””â”€â–º HTTPS Request â†’ api.sri-ketguide.com
                            â”‚
                            â”œâ”€â–º Cloudflare CDN
                            â”‚       â”‚
                            â”‚       â”œâ”€â–º Cloudflare Tunnel (cf-tunnel-api)
                            â”‚       â”‚       â”‚
                            â”‚       â”‚       â””â”€â–º vit-llm-chat-api-1:3000
                            â”‚       â”‚                   â”‚
                            â”‚       â”‚                   â”œâ”€â–º Reads from Database
                            â”‚       â”‚                   â”œâ”€â–º Reads from Cache
                            â”‚       â”‚                   â”œâ”€â–º Calls Embedder
                            â”‚       â”‚                   â””â”€â–º SSE Streaming to Client
```

## ğŸ“Š Service Communication Matrix

| From Service | To Service | Protocol | Port | Purpose |
|--------------|-----------|----------|------|---------|
| PWA (Nginx) | API | HTTPS | 3000 | API requests |
| Frontend Dev | API | HTTP | 3000 | Dev API calls |
| API | Database | TCP | 5432 | SQL queries |
| API | Cache | TCP | 6379 | Redis operations |
| API | Embedder | HTTP | 11400 | Embedding generation |
| API | Worker | Queue | - | Background jobs |
| Tunnels | Services | HTTP | 5174, 3000 | Public access |

## ğŸ”„ Data Flow Types

### 1. **User Authentication Flow**
```
PWA â†’ API (/auth/login) â†’ Database (verify credentials) 
   â†’ Generate JWT â†’ Redis (store session) â†’ Return to PWA
```

### 2. **Chat Message Flow**
```
PWA â†’ API (/chat) â†’ Database (save message) 
   â†’ Worker (process) â†’ Embedder (generate embedding)
   â†’ Database (store embedding) â†’ Ollama (generate response)
   â†’ API (SSE stream) â†’ PWA (display)
```

### 3. **File Upload Flow**
```
PWA â†’ API (/upload) â†’ Multer (save file) 
   â†’ Database (store metadata) â†’ Embedder (process file)
   â†’ Database (store embeddings) â†’ Response to PWA
```

### 4. **History Retrieval Flow**
```
PWA â†’ API (/chat/sessions) â†’ Database (query sessions)
   â†’ Cache (check cache) â†’ Return data
   â†’ Cache (update if needed) â†’ Response to PWA
```

## ğŸŒŸ Key Characteristics

- **All services** run in `vit_llm-chat-network` (bridge network)
- **Public access** via Cloudflare Tunnels (secure HTTPS)
- **Local access** via localhost ports (5173, 3000, 5174)
- **Database** uses pgvector for semantic search
- **Cache** improves response times
- **Worker** handles heavy processing off API thread
- **Embedder** generates vector embeddings for AI search

---

**Updated**: October 28, 2025
**Environment**: Development + Production Tunnels
