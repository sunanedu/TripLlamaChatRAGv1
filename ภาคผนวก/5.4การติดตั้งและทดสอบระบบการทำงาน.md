# ระบบแนะนำธุรกิจอัจฉริยะ (SriKetGuide)
## ระบบติดตั้งและการทดสอบ

---

## สารบัญ
1. [ระบบสามารถเพิ่ม/ลดข้อมูลเพื่อการเรียนรู้ซ้ำได้](#1-ระบบสามารถเพิ่มลดข้อมูลเพื่อการเรียนรู้ซ้ำได้)
2. [ระบบสามารถแสดงชุดคำสั่งและ/หรือกระบวนการจัดการข้อมูลได้](#2-ระบบสามารถแสดงชุดคำสั่งและหรือกระบวนการจัดการข้อมูลได้)
3. [ระบบสามารถเก็บผลตอบรับจากการใช้งานของผู้ใช้ได้](#3-ระบบสามารถเก็บผลตอบรับจากการใช้งานของผู้ใช้ได้)

---

## 1. ระบบสามารถเพิ่ม/ลดข้อมูลเพื่อการเรียนรู้ซ้ำได้

### 1.1 วัตถุประสงค์
ระบบ SriKetGuide รองรับการเพิ่ม ลบ และแก้ไขข้อมูลธุรกิจเพื่อการเรียนรู้ซ้ำ (Re-learning) ผ่านการ:
- ✅ เพิ่มข้อมูลธุรกิจใหม่
- ✅ แก้ไขข้อมูลธุรกิจที่มีอยู่
- ✅ ลบข้อมูลธุรกิจที่หมดอายุหรือไม่ต้องการ
- ✅ อัปเดต Embedding vectors สำหรับการค้นหาที่แม่นยำ

### 1.2 โครงสร้างฐานข้อมูล

#### 1.2.1 ตาราง `businesses` (ข้อมูลธุรกิจ)
```sql
CREATE TABLE businesses (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    business_type VARCHAR(255),
    contact_email VARCHAR(255),
    phone_number VARCHAR(255),
    website_url TEXT,
    is_active BOOLEAN DEFAULT true,
    embedding vector(1536),  -- pgvector สำหรับ semantic search
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**ความหมายของคอลัมน์:**
- `embedding`: เวกเตอร์ 1536 มิติสำหรับการค้นหาแบบ semantic search
- `is_active`: เปิด/ปิดการแสดงผลในระบบ

#### 1.2.2 ตาราง `business_images` (รูปภาพธุรกิจ)
```sql
CREATE TABLE business_images (
    id SERIAL PRIMARY KEY,
    business_id INTEGER REFERENCES businesses(id) ON DELETE CASCADE,
    image_url TEXT,
    caption VARCHAR(255),
    created_at TIMESTAMP
);
```

#### 1.2.3 ตาราง `business_packages` (แพ็คเกจธุรกิจ)
```sql
CREATE TABLE business_packages (
    id SERIAL PRIMARY KEY,
    business_id INTEGER REFERENCES businesses(id),
    package_id INTEGER REFERENCES packages(id),
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP
);
```

### 1.3 ขั้นตอนการเพิ่มข้อมูล

#### วิธีที่ 1: เพิ่มผ่าน API
```bash
# ตัวอย่างคำสั่งเพิ่มธุรกิจ
curl -X POST http://localhost:3000/api/businesses \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "name": "โรงแรมศรีเกษกรีสอร์ท",
    "description": "โรงแรมริมทะเลที่สวยงาม",
    "business_type": "โรงแรม",
    "contact_email": "info@hotel.com",
    "phone_number": "0812345678"
  }'
```

#### วิธีที่ 2: เพิ่มผ่าน Admin Dashboard
```javascript
// ไฟล์: src/components/AdminDashboard.js
// เมื่อผู้ใช้กด "เพิ่มธุรกิจ"
const handleAddBusiness = async () => {
  const response = await fetch('/api/businesses', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(newBusinessData)
  });
  
  // หลังจากเพิ่มสำเร็จ - สร้าง embedding อัตโนมัติ
  await createEmbedding(newBusinessData.id);
};
```

#### วิธีที่ 3: เพิ่มผ่าน Worker (Background Job)
```javascript
// ไฟล์: src/worker/embedding.worker.js
// Worker จะสร้าง embedding อัตโนมัติเมื่อมีธุรกิจใหม่
async function processEmbeddingJob(job) {
  const { businessId, text } = job.data;
  
  // ส่งข้อความไปยัง Ollama Embedding API
  const embedding = await axios.post(
    'http://host.docker.internal:11434/api/embeddings',
    { text }
  );
  
  // อัปเดต embedding ในฐานข้อมูล
  await Business.update(
    { embedding: JSON.stringify(embedding.data.embedding) },
    { where: { id: businessId } }
  );
}
```

### 1.4 ขั้นตอนการลบข้อมูล

#### ลบธุรกิจ (Soft Delete)
```javascript
// ไฟล์: src/controllers/business.controller.js
const deleteBusiness = async (req, res) => {
  const { id } = req.params;
  
  // Soft delete - เปลี่ยน is_active เป็น false
  await Business.update(
    { is_active: false },
    { where: { id } }
  );
  
  // ไม่ลบข้อมูลจริง - เก็บไว้สำหรับประวัติ
  res.json({ message: 'Business deactivated' });
};
```

**คำสั่ง SQL:**
```sql
-- แสดงเฉพาะธุรกิจที่ active
SELECT * FROM businesses WHERE is_active = true;

-- Soft delete
UPDATE businesses SET is_active = false WHERE id = 123;

-- Hard delete (ลบจริง - ระวัง!)
DELETE FROM businesses WHERE id = 123;
```

### 1.5 ขั้นตอนการอัปเดต Embedding

```javascript
// ไฟล์: src/controllers/business.controller.js
const updateBusinessEmbedding = async (businessId) => {
  const business = await Business.findByPk(businessId);
  
  // สร้าง embedding ใหม่
  const embeddingText = `${business.name} ${business.description} ${business.business_type}`;
  const embedding = await axios.post(
    process.env.OLLAMA_EMBED_URL,
    { text: embeddingText }
  );
  
  // อัปเดต embedding ในฐานข้อมูล
  await Business.update(
    { embedding: JSON.stringify(embedding.data.embedding) },
    { where: { id: businessId } }
  );
};
```

### 1.6 ตัวอย่างการใช้งาน

#### เพิ่มธุรกิจใหม่พร้อมรูปภาพ
```bash
# 1. เพิ่มธุรกิจ
curl -X POST http://localhost:3000/api/businesses \
  -d '{"name": "ร้านอาหารศรีเกษ", "business_type": "ร้านอาหาร"}'

# 2. เพิ่มรูปภาพ
curl -X POST http://localhost:3000/api/businesses/1/images \
  -F "image=@/path/to/image.jpg" \
  -F "caption=ภายในร้าน"

# 3. Worker จะสร้าง embedding อัตโนมัติ
# ตรวจสอบ log: docker-compose logs llm-chat-worker
```

---

## 2. ระบบสามารถแสดงชุดคำสั่งและ/หรือกระบวนการจัดการข้อมูลได้

### 2.1 สถาปัตยกรรมระบบ

```
┌─────────────────────────────────────────────────────────────┐
│                      SriKetGuide System                     │
└─────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
    ┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
    │   Frontend   │  │    Backend    │  │   Database   │
    │  (React PWA) │  │  (Node.js)    │  │ (PostgreSQL) │
    └───────┬──────┘  └───────┬──────┘  └───────┬──────┘
            │                 │                 │
            │         ┌────────▼─────────┐      │
            │         │   Worker Jobs    │      │
            │         │  (Background)     │      │
            │         └──────────────────┘      │
            │                                    │
    ┌───────▼───────────┐              ┌───────▼──────┐
    │  Redis Cache      │              │   Ollama     │
    │  (Session Store)  │              │  (LLM API)   │
    └───────────────────┘              └──────────────┘
```

### 2.2 กระบวนการจัดการข้อมูล

#### 2.2.1 กระบวนการ Chat (ถาม-ตอบ)

```
┌──────────────────────────────────────────────────────────┐
│  1. ผู้ใช้พิมพ์คำถาม                                      │
│     "โรงแรมริมทะเลที่ใกล้หาดป่าตอง"                       │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  2. Frontend ส่งคำถามไปยัง Backend API                   │
│     POST /api/chat                                        │
│     Body: { prompt, sessionId }                          │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  3. Backend สร้าง/ค้นหา Chat Session                      │
│     - ถ้าไม่มี sessionId → สร้างใหม่                       │
│     - ถ้ามี sessionId → ใช้ session เดิม                 │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  4. Backend ดึงประวัติแชท (5 ข้อความล่าสุด)              │
│     - ใช้สำหรับ context ให้ LLM                          │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  5. Backend ทำ Semantic Search                           │
│     a) สร้าง embedding จากคำถาม                          │
│     b) ค้นหาด้วย pgvector <-> operator                   │
│     c) เรียงลำดับตาม package tier                        │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  6. Backend สร้าง Final Prompt                            │
│     - Persona Prompt (AI persona)                        │
│     - Conversation History                               │
│     - Context จาก Database                                │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  7. Backend ส่งไปยัง Ollama LLM                          │
│     POST http://ollama:11434/api/generate                 │
│     Model: llama3:8b                                      │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  8. Backend Stream Response กลับไปยัง Frontend            │
│     Content-Type: text/event-stream                       │
└────────────────┬─────────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────────────────┐
│  9. Backend บันทึกคำตอบลงฐานข้อมูล                        │
│     INSERT INTO chat_messages (session_id, role, content) │
└───────────────────────────────────────────────────────────┘
```

#### 2.2.2 คำสั่งและการจัดการข้อมูล

**1. คำสั่งจัดการ User**
```bash
# สร้าง user ใหม่
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "name": "Test User"
  }'

# Login
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'
```

**2. คำสั่งจัดการ Business**
```bash
# ดึงรายการทั้งหมด
curl http://localhost:3000/api/businesses

# เพิ่มธุรกิจ
curl -X POST http://localhost:3000/api/businesses \
  -H "Authorization: Bearer <token>" \
  -d '{"name": "Test Business", "business_type": "ร้านอาหาร"}'

# อัปเดตธุรกิจ
curl -X PUT http://localhost:3000/api/businesses/1 \
  -H "Authorization: Bearer <token>" \
  -d '{"name": "Updated Business"}'

# ลบธุรกิจ (Soft Delete)
curl -X DELETE http://localhost:3000/api/businesses/1 \
  -H "Authorization: Bearer <token>"
```

**3. คำสั่งจัดการ Chat**
```bash
# ส่งข้อความ
curl -X POST http://localhost:3000/api/chat \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "โรงแรมริมทะเล", "sessionId": "xxx"}'

# ดึงประวัติแชท
curl http://localhost:3000/api/chat/sessions \
  -H "Authorization: Bearer <token>"

# ดึงข้อความในห้อง
curl http://localhost:3000/api/chat/xxx/messages \
  -H "Authorization: Bearer <token>"

# ลบห้องแชท
curl -X DELETE http://localhost:3000/api/chat/sessions/xxx \
  -H "Authorization: Bearer <token>"
```

**4. คำสั่ง Docker**
```bash
# เริ่มระบบทั้งหมด
docker-compose -f docker-compose.dev.yml up -d

# หยุดระบบ
docker-compose -f docker-compose.dev.yml down

# ดู logs
docker-compose -f docker-compose.dev.yml logs -f llm-chat-api

# Rebuild service
docker-compose -f docker-compose.dev.yml up -d --build llm-chat-api

# Restart service
docker-compose -f docker-compose.dev.yml restart llm-chat-api
```

### 2.3 การจัดการ Embedding

#### กระบวนการสร้าง Embedding
```javascript
// ไฟล์: src/services/embedding.service.js

const createEmbedding = async (businessId) => {
  // 1. ดึงข้อมูลธุรกิจ
  const business = await Business.findByPk(businessId);
  
  // 2. รวมข้อความสำหรับสร้าง embedding
  const text = `${business.name} ${business.description} ${business.business_type}`;
  
  // 3. ส่งไปยัง Ollama Embedding API
  const response = await axios.post(
    'http://host.docker.internal:11434/api/embeddings',
    { text }
  );
  
  // 4. บันทึกลงฐานข้อมูล
  await Business.update(
    { embedding: JSON.stringify(response.data.embedding) },
    { where: { id: businessId } }
  );
  
  console.log(`Embedding created for business ${businessId}`);
};
```

#### คำสั่งสร้าง Embedding ทั้งหมดใหม่
```bash
# เรียก API เพื่อสร้าง embedding ใหม่
curl -X POST http://localhost:3000/api/businesses/generate-embeddings \
  -H "Authorization: Bearer <token>"

# หรือใช้ Worker
docker-compose exec llm-chat-worker node src/scripts/generate-all-embeddings.js
```

---

## 3. ระบบสามารถเก็บผลตอบรับจากการใช้งานของผู้ใช้ได้

### 3.1 โครงสร้างการเก็บข้อมูลผู้ใช้

#### 3.1.1 ตาราง `users`
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(255),
    role VARCHAR(50) DEFAULT 'member',
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**Roles:**
- `admin`: ผู้ดูแลระบบ
- `staff`: เจ้าหน้าที่
- `member`: สมาชิกทั่วไป
- `guest`: ผู้ใช้ชั่วคราว

#### 3.1.2 ตาราง `chat_sessions`
```sql
CREATE TABLE chat_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id),
    title VARCHAR(255),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 3.1.3 ตาราง `chat_messages`
```sql
CREATE TABLE chat_messages (
    id SERIAL PRIMARY KEY,
    session_id UUID REFERENCES chat_sessions(id) ON DELETE CASCADE,
    role VARCHAR(50),  -- 'user' or 'assistant'
    content TEXT,
    created_at TIMESTAMP
);
```

### 3.2 ขั้นตอนการเก็บข้อมูลการใช้งาน

#### 1. บันทึก Chat Sessions
```javascript
// ไฟล์: src/controllers/chat.controller.js
const handleChat = async (req, res) => {
  const { prompt, sessionId } = req.body;
  const userId = req.user.userId;
  
  // สร้าง session ใหม่ (ถ้าไม่มี)
  let session;
  if (!sessionId) {
    session = await ChatSession.create({
      user_id: userId,
      title: prompt.substring(0, 50)  // ใช้ 50 อักขระแรกเป็น title
    });
  } else {
    session = await ChatSession.findOne({ 
      where: { id: sessionId, user_id: userId } 
    });
  }
  
  // บันทึกข้อความผู้ใช้
  await ChatMessage.create({
    session_id: session.id,
    role: 'user',
    content: prompt
  });
  
  // ... ส่งไปยัง LLM และบันทึกคำตอบ ...
  
  // บันทึกคำตอบจาก AI
  await ChatMessage.create({
    session_id: session.id,
    role: 'assistant',
    content: aiResponse
  });
};
```

#### 2. ดึงประวัติการใช้งาน
```bash
# ดึงรายการ Chat Sessions ทั้งหมด
curl http://localhost:3000/api/chat/sessions \
  -H "Authorization: Bearer <token>"

# Response:
# [
#   {
#     "id": "xxx",
#     "user_id": "yyy",
#     "title": "โรงแรมริมทะเล",
#     "created_at": "2024-01-01T00:00:00Z",
#     "updated_at": "2024-01-01T01:00:00Z"
#   }
# ]
```

```bash
# ดึงข้อความในห้องแชท
curl http://localhost:3000/api/chat/xxx/messages \
  -H "Authorization: Bearer <token>"

# Response:
# [
#   {
#     "id": 1,
#     "session_id": "xxx",
#     "role": "user",
#     "content": "โรงแรมริมทะเล",
#     "created_at": "2024-01-01T00:00:00Z"
#   },
#   {
#     "id": 2,
#     "session_id": "xxx",
#     "role": "assistant",
#     "content": "มีโรงแรมดังนี้...",
#     "created_at": "2024-01-01T00:00:01Z"
#   }
# ]
```

### 3.3 การวิเคราะห์ข้อมูลการใช้งาน

#### 3.3.1 สถิติการใช้งาน
```javascript
// ไฟล์: src/controllers/analytics.controller.js

// นับจำนวน sessions ของผู้ใช้
const getUserSessionsCount = async (userId) => {
  return await ChatSession.count({
    where: { user_id: userId }
  });
};

// นับจำนวนข้อความทั้งหมด
const getUserMessagesCount = async (userId) => {
  return await ChatMessage.count({
    include: [{
      model: ChatSession,
      where: { user_id: userId }
    }]
  });
};

// หาเวลาที่ใช้งานมากที่สุด
const getUsageStats = async (userId) => {
  const sessions = await ChatSession.findAll({
    where: { user_id: userId },
    order: [['created_at', 'DESC']]
  });
  
  return {
    total_sessions: sessions.length,
    first_session: sessions[sessions.length - 1]?.created_at,
    last_session: sessions[0]?.created_at,
    average_messages_per_session: await getAverageMessagesPerSession(userId)
  };
};
```

#### 3.3.2 คำสั่งดึงสถิติ
```bash
# ดึงสถิติผู้ใช้
curl http://localhost:3000/api/analytics/user-stats \
  -H "Authorization: Bearer <token>"

# Response:
# {
#   "total_sessions": 15,
#   "total_messages": 87,
#   "first_session": "2024-01-01T00:00:00Z",
#   "last_session": "2024-01-15T12:30:00Z",
#   "average_messages_per_session": 5.8
# }
```

### 3.4 การเก็บ Feedback จากผู้ใช้

#### Option 1: Rating System (ระบบให้คะแนน)
```sql
-- เพิ่มตาราง ratings
CREATE TABLE chat_session_ratings (
    id SERIAL PRIMARY KEY,
    session_id UUID REFERENCES chat_sessions(id),
    user_id UUID REFERENCES users(id),
    rating INTEGER CHECK (rating BETWEEN 1 AND 5),
    feedback TEXT,
    created_at TIMESTAMP
);
```

```javascript
// บันทึก rating
const submitRating = async (req, res) => {
  const { sessionId, rating, feedback } = req.body;
  const userId = req.user.userId;
  
  await Rating.create({
    session_id: sessionId,
    user_id: userId,
    rating,
    feedback
  });
  
  res.json({ message: 'Rating submitted' });
};
```

#### Option 2: Click Tracking (ติดตามการคลิก)
```javascript
// บันทึกการคลิกข้อความ AI ที่แนะนำ
const trackBusinessClick = async (req, res) => {
  const { businessId, sessionId } = req.body;
  
  await Analytics.create({
    event_type: 'business_click',
    business_id: businessId,
    session_id: sessionId,
    user_id: req.user.userId,
    created_at: new Date()
  });
  
  res.json({ message: 'Click tracked' });
};
```

### 3.5 ตัวอย่างการใช้งาน

#### เก็บข้อมูลการใช้งานจริง
```bash
# 1. User ส่งข้อความ
curl -X POST http://localhost:3000/api/chat \
  -H "Authorization: Bearer <token>" \
  -d '{"prompt": "โรงแรมริมทะเล"}'

# → System จะบันทึก:
# - ChatSession (title: "โรงแรมริมทะเล")
# - ChatMessage (role: "user", content: "โรงแรมริมทะเล")
# - ChatMessage (role: "assistant", content: "...")

# 2. User กลับมาอ่านประวัติ
curl http://localhost:3000/api/chat/sessions \
  -H "Authorization: Bearer <token>"

# → System ดึงรายการ sessions ทั้งหมด

# 3. User อ่านข้อความในห้อง
curl http://localhost:3000/api/chat/{sessionId}/messages \
  -H "Authorization: Bearer <token>"

# → System ดึงข้อความในห้องนั้น

# 4. User ให้คะแนนคำตอบ
curl -X POST http://localhost:3000/api/chat/ratings \
  -H "Authorization: Bearer <token>" \
  -d '{"sessionId": "xxx", "rating": 5, "feedback": "ดีมาก"}'
```

### 3.6 Export ข้อมูลการใช้งาน

```bash
# Export เป็น JSON
curl http://localhost:3000/api/analytics/export \
  -H "Authorization: Bearer <token>" \
  -o user_analytics.json

# Export เป็น CSV
curl http://localhost:3000/api/analytics/export?format=csv \
  -H "Authorization: Bearer <token>" \
  -o user_analytics.csv

# Export ข้อมูลทั้งหมดของ user
curl http://localhost:3000/api/analytics/export-all \
  -H "Authorization: Bearer <token>" \
  -o user_data.json
```

---

## สรุป

### ✅ ระบบสามารถเพิ่ม/ลดข้อมูลเพื่อการเรียนรู้ซ้ำได้
- ✅ เพิ่มธุรกิจใหม่พร้อมรูปภาพ
- ✅ แก้ไขข้อมูลธุรกิจ
- ✅ ลบธุรกิจ (Soft Delete)
- ✅ สร้าง/อัปเดต Embedding vectors
- ✅ Background Worker จัดการ embedding อัตโนมัติ

### ✅ ระบบสามารถแสดงชุดคำสั่งและกระบวนการจัดการข้อมูลได้
- ✅ แสดง Flowchart ของกระบวนการ
- ✅ คำสั่ง API สำหรับจัดการข้อมูล
- ✅ คำสั่ง Docker สำหรับจัดการระบบ
- ✅ กระบวนการสร้าง Embedding
- ✅ กระบวนการ Chat

### ✅ ระบบสามารถเก็บผลตอบรับจากการใช้งานของผู้ใช้ได้
- ✅ บันทึก Chat Sessions
- ✅ บันทึก Chat Messages (user + assistant)
- ✅ เก็บ Rating และ Feedback
- ✅ เก็บสถิติการใช้งาน
- ✅ Export ข้อมูลการใช้งาน

---

## ไฟล์ที่เกี่ยวข้อง

- `docker-compose.dev.yml` - Configuration สำหรับ development
- `llm-chat-backend/src/controllers/` - API Controllers
- `llm-chat-backend/src/models/` - Database Models
- `llm-chat-backend/src/worker/` - Background Jobs
- `llm-chat-frontendpwa/src/` - React Frontend
- `HowtoUse.md` - คู่มือการใช้งานระบบ

---

**อัปเดตล่าสุด:** 28 ตุลาคม 2567  
**Version:** 1.0.0  
**ผู้พัฒนา:** SriKetGuide Team

